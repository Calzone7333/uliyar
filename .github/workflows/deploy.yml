name: Deploy Uliyar (Full Mirror Style)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 1Ô∏è‚É£ Build Frontend locally in GitHub Action
      - name: Build Frontend
        run: |
          cd client
          npm install
          npm run build
          echo "‚úÖ Build complete. Checking dist contents:"
          ls -F dist/

      # 2Ô∏è‚É£ Sync the ENTIRE project folder to the server
      # This ensures local structure = server structure
      - name: Sync Project to Server
        run: |
          rsync -avz --delete \
          --exclude 'node_modules' \
          --exclude 'client/node_modules' \
          --exclude 'server/node_modules' \
          --exclude 'database.sqlite' \
          --exclude '.git' \
          -e "ssh -p 19919 -o StrictHostKeyChecking=no" \
          ./ \
          prakash@103.181.108.248:/home/prakash/apps/uliyar/

      # 3Ô∏è‚É£ Verify and Finalize on Server
      - name: Finalize & Restart
        run: |
          ssh -p 19919 -o StrictHostKeyChecking=no prakash@103.181.108.248 << 'EOF'
            echo "üìÇ Verifying Server Paths..."
            ls -ld /home/prakash/apps/uliyar/server
            ls -l /home/prakash/apps/uliyar/server/index.js
            
            # Update Apache Directory with fresh build
            # Using rsync here is safer than cp
            sudo rsync -avz --delete /home/prakash/apps/uliyar/client/dist/ /var/www/uliyar/
            
            # Setup Backend
            cd /home/prakash/apps/uliyar/server
            npm install --production
            
            # Precise Restart
            echo "üîÑ Restarting Backend on Port 8082..."
            fuser -k 8082/tcp || true
            nohup node index.js > app.log 2>&1 &
            
            # Restart Apache
            sudo systemctl restart apache2
            
            echo "üöÄ Deployment Verified and Complete!"
          EOF